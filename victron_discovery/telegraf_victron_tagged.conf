# Telegraf Configuration for Victron Energy - Tag-based approach
#
# This configuration uses tags for path components instead of flattening field names.
# Better for InfluxDB cardinality management and Grafana variable queries.
#
# STRUCTURE:
# - measurement: device type (battery, grid, vebus, etc.)
# - tags: instance, path components (field, subfield, etc.)
# - field: "value" contains the actual measurement
#
# QUERY EXAMPLES (Flux):
#   from(bucket: "victron")
#     |> filter(fn: (r) => r._measurement == "battery")
#     |> filter(fn: (r) => r.field == "Dc" and r.subfield == "0" and r.metric == "Power")
#
#   // Get all available fields for a device type
#   import "influxdata/influxdb/schema"
#   schema.tagValues(bucket: "victron", tag: "field", predicate: (r) => r._measurement == "battery")

[global_tags]
  portal_id = "c0619ab7d12b"
  source = "victron"

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  flush_interval = "10s"
  flush_jitter = "2s"
  precision = "1s"
  hostname = ""
  omit_hostname = true

###############################################################################
#                            OUTPUT PLUGINS                                   #
###############################################################################

[[outputs.influxdb_v2]]
  urls = ["${TELEGRAF_INFLUXDB_URL}"]
  token = "${TELEGRAF_INFLUXDB_TOKEN}"
  organization = "${TELEGRAF_INFLUXDB_ORG}"
  bucket = "${TELEGRAF_INFLUXDB_BUCKET}"

###############################################################################
#                            INPUT PLUGINS                                    #
###############################################################################

# BATTERY - SmartShunt/BMV monitors
# Instances: 288, 512 (your system has 2 battery monitors)
[[inputs.mqtt_consumer]]
  name_override = "battery"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-battery"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/battery/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+"
    tags = "_/_/_/instance/field"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/subfield"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/subfield/metric"


# GRID - Grid meter (Carlo Gavazzi, etc.)
[[inputs.mqtt_consumer]]
  name_override = "grid"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-grid"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/grid/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/metric"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/phase/metric"


# VEBUS - MultiPlus/Quattro inverter-charger
[[inputs.mqtt_consumer]]
  name_override = "vebus"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-vebus"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/vebus/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/metric"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/phase/metric"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/device/subfield/metric"


# SYSTEM - System-wide overview metrics
[[inputs.mqtt_consumer]]
  name_override = "system"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-system"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/system/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/metric"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/subfield/metric"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+/+/+"
    tags = "_/_/_/instance/field/subfield/phase/metric"


# TEMPERATURE - Ruuvi/temperature sensors
# Instances: 22, 23, 24 (your system has 3 temperature sensors)
[[inputs.mqtt_consumer]]
  name_override = "temperature"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-temperature"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/temperature/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+"
    tags = "_/_/_/instance/field"


# PVINVERTER - PV Inverters (Fronius, etc.)
# Instances: 21, 23, 24, 25 (your system has 4 PV inverter connections)
[[inputs.mqtt_consumer]]
  name_override = "pvinverter"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-pvinverter"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/pvinverter/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+"
    tags = "_/_/_/instance/field"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/metric"


# HUB4 - ESS/Hub4 control
[[inputs.mqtt_consumer]]
  name_override = "hub4"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-hub4"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/hub4/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+"
    tags = "_/_/_/instance/field"


# VECAN - VE.Can bus sensors
[[inputs.mqtt_consumer]]
  name_override = "vecan"
  servers = ["${TELEGRAF_MQTT_SERVER}"]
  client_id = "telegraf-vecan"
  qos = 0
  username = "${TELEGRAF_MQTT_USERNAME}"
  password = "${TELEGRAF_MQTT_PASSWORD}"
  insecure_skip_verify = true

  topics = ["N/${VICTRON_PORTAL_ID}/vecan/#"]

  data_format = "json_v2"
  [[inputs.mqtt_consumer.json_v2]]
    [[inputs.mqtt_consumer.json_v2.field]]
      path = "value"

  [[inputs.mqtt_consumer.topic_parsing]]
    topic = "N/+/+/+/+/+"
    tags = "_/_/_/instance/field/metric"
