#######################################
# Docker Services - Stack: pv-stack
# Generated: Sun Nov 30 08:46:55 PM UTC 2025
# Network: pv-stack-network
#######################################

services:

  esphome:
    image: ghcr.io/esphome/esphome:latest
    container_name: pv-stack-esphome
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${ESPHOME_PORT:-6052}:6052"
    environment:
      - TZ=${TZ}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/esphome/config:/config

  grafana:
    image: grafana/grafana:latest
    container_name: pv-stack-grafana
    restart: unless-stopped
    depends_on:
      - influxdb
      - grafana-image-renderer
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    user: "${PUID}:${PGID}"
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GF_SECURITY_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GF_SECURITY_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_RENDERING_SERVER_URL=${GF_RENDERING_SERVER_URL:-}
      - GF_RENDERING_CALLBACK_URL=${GF_RENDERING_CALLBACK_URL:-}
      - GF_UNIFIED_ALERTING_SCREENSHOTS_CAPTURE=${GF_UNIFIED_ALERTING_SCREENSHOTS_CAPTURE:-false}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/grafana/data:/var/lib/grafana
      - ${DOCKER_ROOT}/pv-stack/grafana/provisioning:/etc/grafana/provisioning

  grafana-image-renderer:
    image: grafana/grafana-image-renderer:latest
    container_name: pv-stack-grafana-image-renderer
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${RENDERING_PORT:-8081}:8081"
    environment:
      - ENABLE_METRICS=true
      - RENDERING_MODE=${RENDERING_MODE:-clustered}
      - RENDERING_CLUSTERING_MODE=${RENDERING_CLUSTERING_MODE:-context}
      - RENDERING_CLUSTERING_MAX_CONCURRENCY=${RENDERING_CLUSTERING_MAX_CONCURRENCY:-5}
      - RENDERING_VERBOSE_LOGGING=${RENDERING_VERBOSE_LOGGING:-false}
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8081/"]
      interval: 30s
      timeout: 10s
      start_period: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  influxdb:
    image: influxdb:2.7
    container_name: pv-stack-influxdb
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=${DOCKER_INFLUXDB_INIT_MODE:-setup}
      - DOCKER_INFLUXDB_INIT_USERNAME=${DOCKER_INFLUXDB_INIT_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${DOCKER_INFLUXDB_INIT_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${DOCKER_INFLUXDB_INIT_ORG:-homelab}
      - DOCKER_INFLUXDB_INIT_BUCKET=${DOCKER_INFLUXDB_INIT_BUCKET:-default}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/influxdb/data/data:/var/lib/influxdb2
      - ${DOCKER_ROOT}/pv-stack/influxdb/config:/etc/influxdb2

  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: pv-stack-mosquitto
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${MQTT_PORT:-1883}:1883"
      - "${MQTT_WS_PORT:-9001}:9001"
    volumes:
      - ${DOCKER_ROOT}/pv-stack/mosquitto/config:/mosquitto/config
      - ${DOCKER_ROOT}/pv-stack/mosquitto/data:/mosquitto/data
      - ${DOCKER_ROOT}/pv-stack/mosquitto/logs:/mosquitto/log

  mqtt-explorer:
    image: smeagolworms4/mqtt-explorer:latest
    container_name: pv-stack-mqtt-explorer
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${MQTT_EXPLORER_PORT:-4000}:4000"
    volumes:
      - ${DOCKER_ROOT}/pv-stack/mqtt-explorer/config:/mqtt-explorer/config
    depends_on:
      - mosquitto

  nodered:
    image: nodered/node-red:latest
    container_name: pv-stack-nodered
    restart: unless-stopped
    depends_on:
      - mosquitto
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    user: "${PUID}:${PGID}"
    ports:
      - "${NODERED_PORT:-1880}:1880"
    environment:
      - TZ=${TZ}
      - NODE_RED_CREDENTIAL_SECRET=${NODE_RED_CREDENTIAL_SECRET}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/nodered/data:/data

  portainer:
    image: ${PORTAINER_IMAGE:-portainer/portainer-ce:latest}
    container_name: pv-stack-portainer
    restart: always
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${PORTAINER_PORT:-9443}:9443"
      - "8000:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${DOCKER_ROOT}/pv-stack/portainer/data:/data

  redis:
    image: redis:alpine
    container_name: pv-stack-redis
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - ${DOCKER_ROOT}/pv-stack/redis/data:/data

  seplos-modbus-mqtt:
    build:
      context: /home/stefanm/docker-setup/templates/seplos-modbus-mqtt
      dockerfile: Dockerfile
    image: seplos-modbus-mqtt:latest
    container_name: pv-stack-seplos-modbus-mqtt
    restart: unless-stopped
    depends_on:
      - mosquitto
      - influxdb
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    network_mode: host
    devices:
      - ${SEPLOS_SERIAL_PORT:-/dev/ttyUSB0}:${SEPLOS_SERIAL_PORT:-/dev/ttyUSB0}
    environment:
      - SERIAL_PORT=${SEPLOS_SERIAL_PORT:-/dev/ttyUSB0}
      - SERIAL_BAUDRATE=${SEPLOS_SERIAL_BAUDRATE:-19200}
      - MQTT_SERVER=${SEPLOS_MQTT_SERVER:-localhost}
      - MQTT_PORT=${SEPLOS_MQTT_PORT:-1883}
      - MQTT_USERNAME=${SEPLOS_MQTT_USERNAME:-}
      - MQTT_PASSWORD=${SEPLOS_MQTT_PASSWORD:-}
      - MQTT_PREFIX=${SEPLOS_MQTT_PREFIX:-seplos}
      - MQTT_PUBLISH_MODE=${SEPLOS_MQTT_PUBLISH_MODE:-changed}
      - INFLUXDB_ENABLED=${SEPLOS_INFLUXDB_ENABLED:-false}
      - INFLUXDB_URL=${SEPLOS_INFLUXDB_URL:-http://localhost:8086}
      - INFLUXDB_TOKEN=${SEPLOS_INFLUXDB_TOKEN:-}
      - INFLUXDB_ORG=${SEPLOS_INFLUXDB_ORG:-homelab}
      - INFLUXDB_BUCKET=${SEPLOS_INFLUXDB_BUCKET:-seplos}
      - INFLUXDB_WRITE_INTERVAL=${SEPLOS_INFLUXDB_WRITE_INTERVAL:-5}
      - INFLUXDB_PUBLISH_MODE=${SEPLOS_INFLUXDB_PUBLISH_MODE:-changed}
      - HEALTH_CHECK_INTERVAL=${SEPLOS_HEALTH_CHECK_INTERVAL:-60}
      - HEALTH_STALE_TIMEOUT=${SEPLOS_HEALTH_STALE_TIMEOUT:-120}
      - GENERAL_LOG_LEVEL=${SEPLOS_LOG_LEVEL:-INFO}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/seplos-modbus-mqtt/config:/app/config:ro
    healthcheck:
      test: ["CMD", "python3", "/app/healthcheck.py"]
      interval: 60s
      timeout: 10s
      start_period: 60s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  tasmoadmin:
    image: ghcr.io/tasmoadmin/tasmoadmin:latest
    container_name: pv-stack-tasmoadmin
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    ports:
      - "${TASMOADMIN_PORT:-9541}:80"
    environment:
      - TZ=${TZ}
    volumes:
      - ${DOCKER_ROOT}/pv-stack/tasmoadmin/data:/data

  watchtower:
    image: containrrr/watchtower:latest
    container_name: pv-stack-watchtower
    restart: unless-stopped
    labels:
      - "com.docker.compose.project=pv-stack"
      - "io.portainer.accesscontrol.teams=pv-stack"
    environment:
      - WATCHTOWER_CLEANUP=${WATCHTOWER_CLEANUP:-true}
      - WATCHTOWER_SCHEDULE=${WATCHTOWER_SCHEDULE:-0 0 4 * * *}
      - TZ=${TZ}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock


networks:
  default:
    name: pv-stack-network
    driver: bridge
