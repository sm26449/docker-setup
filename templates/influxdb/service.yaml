name: influxdb
description: "Time-series database"

variables:
  INFLUXDB_PORT:
    default: "8086"
    description: "InfluxDB port"
    prompt: true
  DOCKER_INFLUXDB_INIT_USERNAME:
    default: "admin"
    description: "Admin username"
    prompt: true
  DOCKER_INFLUXDB_INIT_PASSWORD:
    default: ""
    description: "Admin password"
    generate: password
    prompt: true
  DOCKER_INFLUXDB_INIT_ORG:
    default: "homelab"
    description: "Organization name"
    prompt: true
  DOCKER_INFLUXDB_INIT_BUCKET:
    default: "default"
    description: "Default bucket"
    prompt: true
  DOCKER_INFLUXDB_INIT_ADMIN_TOKEN:
    default: ""
    description: "Admin API token (auto-generated if empty)"
    generate: random
  DOCKER_INFLUXDB_INIT_MODE:
    default: "setup"
    description: "Init mode"

hooks:
  post_deploy:
    - "echo 'InfluxDB deployed. API Token for other services:'"
    - "echo '  INFLUXDB_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}'"

compose: |
  ${SERVICE_NAME}:
    image: influxdb:2.7
    container_name: ${SERVICE_NAME}
    restart: unless-stopped
    ports:
      - "${INFLUXDB_PORT:-8086}:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=${DOCKER_INFLUXDB_INIT_MODE:-setup}
      - DOCKER_INFLUXDB_INIT_USERNAME=${DOCKER_INFLUXDB_INIT_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${DOCKER_INFLUXDB_INIT_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${DOCKER_INFLUXDB_INIT_ORG:-homelab}
      - DOCKER_INFLUXDB_INIT_BUCKET=${DOCKER_INFLUXDB_INIT_BUCKET:-default}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${DOCKER_INFLUXDB_INIT_ADMIN_TOKEN}
    volumes:
      - ${DOCKER_ROOT}/${SERVICE_NAME}/data/data:/var/lib/influxdb2
      - ${DOCKER_ROOT}/${SERVICE_NAME}/config:/etc/influxdb2
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      start_period: 30s
      retries: 3
