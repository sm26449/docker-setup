# Mosquitto Bridge Configuration
# Generated by Docker Services Manager
#
# This configuration creates a bridge between a remote MQTT broker
# and this local broker, allowing local clients to access remote topics.

# =============================================================================
# LOCAL BROKER SETTINGS
# =============================================================================

# Disable anonymous access (require authentication)
allow_anonymous false

# Standard MQTT listener
listener 1883

# WebSocket listener
listener 9001
protocol websockets

# Password file for authentication
password_file /mosquitto/config/pwfile

# Persistence settings
persistence true
persistence_file mosquitto.db
persistence_location /mosquitto/data/

# Logging
log_dest file /mosquitto/log/mosquitto.log
log_dest stdout
log_type error
log_type warning
log_type notice
log_type information
log_type subscribe
log_type unsubscribe

# Connection settings
max_connections -1

# =============================================================================
# BRIDGE CONNECTION TO REMOTE BROKER
# =============================================================================

connection ${BRIDGE_NAME}

# Remote broker address
# Format: hostname:port
address ${REMOTE_MQTT_HOST}:${REMOTE_MQTT_PORT}

# Bridge protocol version (use mqttv311 for compatibility)
bridge_protocol_version mqttv311

# Connection settings
keepalive_interval ${BRIDGE_KEEPALIVE}
restart_timeout ${BRIDGE_RESTART_TIMEOUT}
try_private true
cleansession false

# Remote broker authentication (if required)
remote_username ${REMOTE_MQTT_USERNAME}
remote_password ${REMOTE_MQTT_PASSWORD}

# SSL/TLS settings - configured dynamically via hook if REMOTE_MQTT_USE_SSL=true
#SSL_PLACEHOLDER#

# =============================================================================
# TOPIC BRIDGING
# =============================================================================
#
# Topic pattern format:
#   topic <pattern> [[[<direction>] <QoS>] <local_prefix> <remote_prefix>]
#
# Directions:
#   in   - Subscribe from remote, publish locally
#   out  - Subscribe locally, publish to remote
#   both - Bidirectional
#
# Examples:
#   topic sensors/# in 1        - Read all sensors from remote
#   topic commands/# out 1      - Send commands to remote
#   topic # both 1 local/ ""    - Full bidirectional with local prefix

# Topics to subscribe FROM remote broker (read remote data locally)
# These topics will be available on your local broker
topic ${BRIDGE_TOPICS_IN} in ${BRIDGE_QOS}

# =============================================================================
# BRIDGE STATUS NOTIFICATIONS
# =============================================================================
#
# Mosquitto publishes connection status to these topics:
#   $SYS/broker/connection/<bridge_name>/state
#     - 1 = connected
#     - 0 = disconnected
#
# We also configure a Last Will and Testament (LWT) message
# so clients know when the bridge goes offline

# Bridge status notification
notifications true
notification_topic bridge/${BRIDGE_NAME}/status

# Last Will and Testament - published when bridge disconnects unexpectedly
# This helps clients detect when the remote connection is lost
